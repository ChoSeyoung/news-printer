name: Auto Publish News

on:
  schedule:
    # 매일 오전 9시 (한국 시간 오전 6시 UTC)
    - cron: '0 0 * * *'

  # 수동 실행 옵션
  workflow_dispatch:
    inputs:
      category:
        description: 'News category'
        required: false
        default: 'politics'
      limit:
        description: 'Number of news items'
        required: false
        default: '10'

jobs:
  publish-news:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install FFmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Create temp directory
        run: mkdir -p temp

      - name: Setup Google Cloud credentials
        run: |
          echo '${{ secrets.GOOGLE_CLOUD_CREDENTIALS }}' > google-credentials.json
          echo "GOOGLE_APPLICATION_CREDENTIALS=$(pwd)/google-credentials.json" >> $GITHUB_ENV

      - name: Setup YouTube OAuth credentials
        run: |
          echo '${{ secrets.YOUTUBE_CLIENT_SECRET }}' > client_secret.json

      - name: Setup YouTube tokens
        run: |
          mkdir -p credentials
          echo '${{ secrets.YOUTUBE_TOKENS }}' > credentials/youtube-tokens.json

      - name: Create .env file
        run: |
          cat > .env << EOF
          PORT=3000
          RSS_BASE_URL=https://www.chosun.com/arc/outboundfeeds/rss/category
          RSS_TIMEOUT=10000
          RSS_DEFAULT_CATEGORY=politics
          RSS_DEFAULT_LIMIT=10
          GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
          GOOGLE_APPLICATION_CREDENTIALS=google-credentials.json
          YOUTUBE_CLIENT_SECRET_PATH=client_secret.json
          YOUTUBE_TOKENS_PATH=credentials/youtube-tokens.json
          EOF

      - name: Build application
        run: npm run build

      - name: Start server in background
        run: |
          nohup npm run start:prod > server.log 2>&1 &
          echo $! > server.pid
          sleep 10

      - name: Wait for server to be ready
        run: |
          for i in {1..30}; do
            if curl -s http://localhost:3000 > /dev/null; then
              echo "Server is ready!"
              exit 0
            fi
            echo "Waiting for server... ($i/30)"
            sleep 2
          done
          echo "Server failed to start"
          cat server.log
          exit 1

      - name: Publish news
        id: publish
        run: |
          CATEGORY="${{ github.event.inputs.category || 'politics' }}"
          LIMIT="${{ github.event.inputs.limit || '10' }}"

          echo "Publishing news: category=$CATEGORY, limit=$LIMIT"

          RESPONSE=$(curl -s -X POST http://localhost:3000/news/publish-all \
            -H "Content-Type: application/json" \
            -d "{\"category\": \"$CATEGORY\", \"limit\": $LIMIT, \"privacyStatus\": \"unlisted\"}")

          echo "Response: $RESPONSE"
          echo "$RESPONSE" > publish-result.json

          # Extract results
          SUCCESSFUL=$(echo "$RESPONSE" | jq -r '.successful')
          FAILED=$(echo "$RESPONSE" | jq -r '.failed')
          TOTAL=$(echo "$RESPONSE" | jq -r '.totalProcessed')

          echo "successful=$SUCCESSFUL" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT

          # 결과 출력
          echo "### Publishing Results" >> $GITHUB_STEP_SUMMARY
          echo "- Total Processed: $TOTAL" >> $GITHUB_STEP_SUMMARY
          echo "- Successful: $SUCCESSFUL" >> $GITHUB_STEP_SUMMARY
          echo "- Failed: $FAILED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Video Links" >> $GITHUB_STEP_SUMMARY
          echo "$RESPONSE" | jq -r '.results[] | select(.success == true) | "- [\(.title)](\(.videoUrl))"' >> $GITHUB_STEP_SUMMARY

      - name: Stop server
        if: always()
        run: |
          if [ -f server.pid ]; then
            kill $(cat server.pid) || true
            rm server.pid
          fi

      - name: Upload server logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: server-logs
          path: server.log

      - name: Upload publish results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: publish-results
          path: publish-result.json

      - name: Cleanup credentials
        if: always()
        run: |
          rm -f google-credentials.json
          rm -f client_secret.json
          rm -rf credentials
          rm -f .env

      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::News publishing failed. Check logs for details."
